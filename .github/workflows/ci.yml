name: CI

on:
  push:
    branches: [ '*' ]
  pull_request:
    branches: [ '*' ]
  workflow_dispatch: {}

permissions:
  contents: read
  checks: write        # Required for test-reporter to create the status check
  pull-requests: write # Required if you want PR comments

jobs:
  android-tests:
    name: Android TV Tests
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install MAUI Android workload
        # Removed the --yes flag which caused the previous error
        run: dotnet workload install maui-android

      - name: Build test app (Debug)
        run: |
          dotnet build samples/TestRunner/TestRunner.csproj -c Debug -f net10.0-android /p:AndroidPackageFormat=apk

      - name: Find APK
        id: find-apk
        run: |
          apk=$(find samples/TestRunner -type f -name "*Debug*.apk" | head -n 1)
          echo "Found APK: $apk"
          echo "APK_PATH=$apk" >> $GITHUB_ENV

      - name: Run Tests on Android TV Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          arch: x86_64
          target: android-tv
          force-avd-creation: true
          emulator-options: -no-window -gpu swiftshader_indirect -no-audio -no-boot-anim
          script: |
            dotnet tool install --global Microsoft.DotNet.XHarness.CLI
            xharness android test \
              --app "$APK_PATH" \
              --package-name "com.companyname.testrunner" \
              --output-directory "test-results" \
              --timeout "00:10:00"

      # This makes the results visible in the "Checks" tab and PRs
      - name: Test Report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Android TV Test Results
          path: 'test-results/**/TestResults.xml'
          reporter: java-junit # XHarness Android outputs JUnit style XML

      # This creates the "Job Summary" dashboard you see on the run's main page
      - name: Summary to Logs
        if: always()
        run: |
          echo "### ðŸš€ Android TV Test Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f test-results/TestResults.xml ]; then
            # Simple bash to extract pass/fail counts for the log
            PASSED=$(grep -c "<testcase" test-results/TestResults.xml || true)
            FAILED=$(grep -c "<failure" test-results/TestResults.xml || true)
            echo "* **Status:** $([ "$FAILED" -eq "0" ] && echo "âœ… Passed" || echo "âŒ Failed")" >> $GITHUB_STEP_SUMMARY
            echo "* **Total Tests:** $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "* **Failures:** $FAILED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No test results file found. Check the 'Run Tests' step for crashes." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results

  publish:
    name: Build and publish package
    runs-on: ubuntu-latest # Using Ubuntu for cheaper publish job
    needs: android-tests
    if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Build and pack
        run: |
          dotnet pack src/Plugin.Maui.TvDPad/Plugin.Maui.TvDPad.csproj -c Release -o ./artifacts

      - name: Publish to NuGet
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          dotnet nuget push ./artifacts/*.nupkg -k $NUGET_API_KEY -s https://api.nuget.org/v3/index.json
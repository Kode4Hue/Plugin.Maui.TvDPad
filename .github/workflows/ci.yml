name: CI

on:
  push:
    branches: [ '*' ]
  pull_request:
    branches: [ '*' ]
  workflow_dispatch: {}

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  android-tests:
    name: Android TV Tests
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install MAUI Android workload
        run: dotnet workload install maui-android

      - name: Build test app (Debug)
        run: |
          dotnet build samples/TestRunner/TestRunner.csproj -c Debug -f net10.0-android /p:AndroidPackageFormat=apk

      - name: Find APK
        id: find-apk
        run: |
          apk=$(find samples/TestRunner -type f -name "*Debug*.apk" | head -n 1)
          echo "APK_PATH=$apk" >> $GITHUB_ENV

      - name: Run Tests on Android TV Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          arch: x86_64
          target: android-tv
          force-avd-creation: true
          emulator-options: -no-window -gpu swiftshader_indirect -no-audio -no-boot-anim
          script: |
            dotnet tool install --global Microsoft.DotNet.XHarness.CLI
            export PATH="$PATH:$HOME/.dotnet/tools"
            
            # Run tests. XHarness pulls files from the device to --output-directory
            xharness android test \
              --app "$APK_PATH" \
              --package-name "com.companyname.testrunner" \
              --output-directory "xharness-output" \
              --timeout "00:10:00" \
              --verbosity=Debug

      - name: Prepare Test Results
        if: always()
        run: |
          # Ensure directory exists and is readable
          mkdir -p test-results
          if [ -d "xharness-output" ]; then
            # Find any XML file (XHarness often names them after the device/timestamp)
            # and copy it to a predictable location for the reporter
            find xharness-output -name "*.xml" -exec cp {} test-results/results.xml \;
            chmod -R 777 test-results
            echo "Files found in xharness-output:"
            ls -R xharness-output
          else
            echo "XHarness output directory not found!"
          fi

      - name: Test Report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Android TV Test Results
          path: 'test-results/results.xml'
          reporter: java-junit

      - name: Summary to Job Log
        if: always()
        run: |
          echo "### ðŸš€ Android TV Test Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f test-results/results.xml ]; then
            PASSED=$(grep -c "<testcase" test-results/results.xml || true)
            FAILED=$(grep -c "<failure" test-results/results.xml || true)
            echo "* **Status:** $([ "$FAILED" -eq "0" ] && echo "âœ… Passed" || echo "âŒ Failed")" >> $GITHUB_STEP_SUMMARY
            echo "* **Tests Found:** $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "* **Failures:** $FAILED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No XML results were generated. Check 'Run Tests' logs for app crashes." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: full-xharness-logs
          path: xharness-output
name: CI

on:
  push:
    branches:
      - '*'
  pull_request:
    branches:
      - '*'
  workflow_dispatch: {}

jobs:
  build-android:
    runs-on: windows-latest
    strategy:
      matrix:
        configuration: [Release]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      # âš¡ Cache .NET SDK + MAUI workloads
      - name: Cache .NET workloads
        uses: actions/cache@v4
        with:
          path: |
            ~\.dotnet
          key: dotnet-${{ runner.os }}-maui-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            dotnet-${{ runner.os }}-maui-

      # ðŸ”‘ Android-only workload (Windows-safe)
      - name: Install MAUI Android workload
        run: dotnet workload install maui-android

      # âœ… Restore Android TFM only for the MAUI library
      - name: Restore (Android library)
        run: dotnet restore src/Plugin.Maui.TvDPad/Plugin.Maui.TvDPad.csproj `
          -p:TargetFramework=net10.0-android

      # âœ… Build Android TFM only for the MAUI library
      - name: Build (Android library)
        run: dotnet build src/Plugin.Maui.TvDPad/Plugin.Maui.TvDPad.csproj `
          --framework net10.0-android `
          --configuration ${{ matrix.configuration }} `
          --no-restore

      # âœ… Prepare deterministic test results folder
      - name: Prepare TestResults folder
        run: New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\TestResults" | Out-Null

      # âœ… Restore tests while forcing referenced MAUI project to Android only (prevents iOS workload error)
      - name: Restore (Tests)
        run: dotnet restore src/tests/Plugin.Maui.TvDPad.Tests/Plugin.Maui.TvDPad.Tests.csproj `
          -p:TargetFramework=net10.0-android

      # âœ… Build tests with the same forced TFM (so dotnet test can run with --no-build)
      - name: Build (Tests)
        run: dotnet build src/tests/Plugin.Maui.TvDPad.Tests/Plugin.Maui.TvDPad.Tests.csproj `
          --configuration ${{ matrix.configuration }} `
          -p:TargetFramework=net10.0-android `
          --no-restore

      # âœ… Run tests without rebuilding; emit console output + TRX into workspace
      - name: Test
        run: dotnet test src/tests/Plugin.Maui.TvDPad.Tests/Plugin.Maui.TvDPad.Tests.csproj `
          --configuration ${{ matrix.configuration }} `
          --no-build `
          --verbosity normal `
          --logger "console;verbosity=detailed" `
          --logger "trx;LogFileName=tests.trx" `
          --results-directory "$env:GITHUB_WORKSPACE\TestResults"

      # ðŸ”Ž Debug visibility: show what got produced
      - name: List TestResults
        if: always()
        run: |
          Write-Host "Contents of TestResults:"
          Get-ChildItem -Recurse "$env:GITHUB_WORKSPACE\TestResults" | Select-Object FullName,Length

      # ðŸ“¦ Upload test results
      - name: Publish test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults
          if-no-files-found: warn
